---
title: "Re-Analysis of Ruggeri et al 2022 (Pre-submission)"
output: html_notebook
author: "Hu Chuan-Peng"
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook for re-analyzing the sample in paper [The globalizability of temporal discounting](https://www.nature.com/articles/s41562-022-01392-w). 

Aim: Illustrate the representativeness of Chinese data in terms of gender, age, educational attainment, geographical distribution, and huokou (a Chinese special identity related to residence of rural/urban).

## Load data
```{r load data}
rm(list = ls())

if (!require("pacman")) install.packages("pacman")      # install the package manager pacman
pacman::p_load(tidyverse, easystats, patchwork, here)

# Load pre-processed census data, not that the largest age means >= that value
load(here::here("Re_Analysis_CHN.RData"))
# load(here::here("1_2_data_files.RData"))

# library(tidyverse)
# library(easystats)
# library(patchwork)

source(here::here("Functions.r"))
```

# Sample representativeness: Taking the Chinese participants as an example

Here we compare the Chinese participants' data with the census data in the following dimensions:

* Sex and age
* Educational attainment
* Geographical distribution
* Hukou (family type in terms of rural vs. urban)

## Preprocessing
We extracted data from Ruggeri et al (2022). Based on the description from the pre-registration, we only selected adults data from census data.

Excerpt from pre-registration (https://osf.io/jfvh4): *Adult participants from 18 years of age and up (in some countries, 19 or 21 is the minimum age to participate in research) will be recruited from 65 countries, covering 41 languages.*

Here is the description of the participant in the paper:

*The final dataset was composed of 13,629 responses from 61 countries. The original sample size was 25,877, which was reduced almost by half after we performed pre-registered data exclusions. We removed 6,141 participants (23.7%) who did not pass our attention check (a choice between receiving 10% of monthly income now or paying the same amount in one year). We removed 69 participants for presenting nonsensical responses to open data text (for example, ‘helicopter’ as gender). We removed 13 participants claiming to be over 100 years old. We included additional filters to our original exclusion criteria. Regarding the length of time for responses, individuals faster than three times the absolute deviation below the median time or that took less than 120 seconds to respond were removed. This criterion allowed us to identify 5,870 inappropriate responses. We further removed responses from IP addresses identified as either ‘tests’ or ‘spam’ by the Qualtrics service (264 answers identified). Lastly, we did not consider individuals not completing over 90% of the survey (9,434 responses failed this criterion). Note that these values add up to more than 100% because participants could fail multiple criteria.*

```{r data preparation}

### code for preparing census data about education, will not used after saving RData
# df_tmp <- bruceR::import(here::here("A0401_CNH_Census7_Age_education_edited.xls"))
# # 
# # # create a list of columans
# edu_colnames <- tidyr::crossing(c("pop", "noSchool", "preSchool", "elementary",
#                                   "middle", "high", "technical", "university", "master", "PhD"),
#                                 c("all", "male", "fmale")) %>%
#   dplyr::rename("edu" = 1, "sex" = 2 ) %>%
#   dplyr::mutate(edu = factor(edu, levels = c("pop", "noSchool", "preSchool", "elementary",
#                                   "middle", "high", "technical", "university", "master", "PhD"))) %>%
#   dplyr::arrange(edu) %>%
#   tidyr::unite(cols, edu:sex, remove = FALSE) %>%
#   dplyr::pull(cols)
# 
# colnames(df_tmp) <- c("Age", edu_colnames)
# 
# df_census7_edu <- df_tmp %>%
#   dplyr::mutate(Age = ifelse(Age == "85岁及以上", 85, Age)) %>%
#   dplyr::mutate(Age = as.numeric(Age)) %>%
#   dplyr::filter(!is.na(Age))

# df_census7_edu <- df_census7_edu %>% rename_with( ~ gsub("_fmale", "_female", .x, fixed = TRUE))  # replace "fmale" with "female"

# save(df_census7_age, df_census7_edu, file = here::here("CHN_Census.RData"))

# extract the Chinese from Ruggeri et al (2022)
# dat_cn <- dat_unique %>%  
#   dplyr::filter(Residence == "China") %>%
#   dplyr::select(ResponseId, Gender, EducationCompleted, Residence, Age, "Ethnic", "REGION" )

# # clean the census data (age & sex)
# df_census7_age<- df_census7_age %>%
#   dplyr::select(c(1, 3, 4)) %>%        
#   # dplyr::slice(c(9:13, 16:20, 23:27, 141:145)) %>%
#   dplyr::rename(Age=1, 
#                 Male = 2,
#                 Female=3) %>%
#   dplyr::mutate(Age = ifelse(Age == "100岁及以上", 100, Age)) %>% # convert >=100 to 100
#   dplyr::mutate(Age = as.numeric(Age)) %>%
#   dplyr::filter(!is.na(Age)) 

# save(df_census7_edu, dat_cn, file = here::here("Re_Analysis_CHN.RData"))
```

Total number of participants in China is `n = `r length(unique(dat_cn$ResponseId))``.

## Gender & Sex (pyramids plots)

```{r Sex and Age, message=FALSE, warning=FALSE}
df_census7_adults <- df_census7_edu %>%
  dplyr::filter(Age >= 18)
dat_gender <- dat_cn %>%
  dplyr::filter(Gender == "Female" | Gender == "Male") %>%
  dplyr::count(Gender) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 2) * 100,
                Site = "Ruggeri_2022") %>%
  dplyr::select(Site, Gender, Proportion) %>%
  dplyr::rename(Sex = Gender)

df_census7_adults_sex <- df_census7_adults %>%
  dplyr::select(pop_fmale, pop_male) %>%
  dplyr::mutate_if(is.character, as.numeric) %>%
  # dplyr::select(-Age) %>%
  colSums() %>%
  data.frame() %>%
  dplyr::rename(N=".")

df_census7_adults_sex$Sex <- rownames(df_census7_adults_sex)

df_census7_adults_sex <- df_census7_adults_sex %>%
  dplyr::mutate(Sex = ifelse(Sex == "pop_fmale", "Female", "Male"))
  
df_census7_adults_sex <- df_census7_adults_sex %>%
  dplyr::mutate(Proportion = N/sum(N)) %>%
  dplyr::mutate(Site = "Census7") %>%
  dplyr::select(Site, Sex, Proportion) %>%
  dplyr::mutate(Proportion = round(as.numeric(Proportion*100), 0))

rownames(df_census7_adults_sex) <- NULL

df_sex_ratio <- rbind(dat_gender, df_census7_adults_sex)

### get the data for Bayesian mutlinomial test as in JASP
df_sex_ratio_jasp <- df_sex_ratio %>%
  tidyr::pivot_wider(names_from = Site,
                     values_from = Proportion)

BF_h2a_sex<- BayesMultiNomial(dataset = df_sex_ratio_jasp, factor = "Gender", observed = "Ruggeri_2022", expected = "Census7")

fig1a <- ggplot(df_sex_ratio, aes(Site, Proportion,fill=Sex)) +
  geom_col() +
  theme_classic()+
  xlab("Data sources") +
  theme(legend.position = "bottom",
        legend.key.size = unit(20,"pt"),
        legend.box.spacing = unit(4,"pt"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16, family = "serif"),
        legend.text = element_text(size = 16, family = "serif"),
        axis.text = element_text(size =16, family = "serif"))

fig1a 
```


### Age bins
```{r H2b ageBins plot, message=FALSE, warning=FALSE}
#  
dat_age_Ruggeri2022 <- dat_cn %>%
  dplyr::filter(!is.na(Age)) %>%
  dplyr::mutate(ageBins_pyr = cut(Age, 
                                   breaks=c(17, 22, 27, 32, 37, 42, 47,
                                            52, 57,62,67,72, 77, Inf), 
                            labels=c("17~21", "22~26", "27~31", "32~36", "31~41", "42~46",
                                     "47~51","52~56","57~61","62~66","67~71","72~76", ">=77")),
                ageBins_pyr = factor(ageBins_pyr, 
                                     levels = c("17~21", "22~26", "27~31", "32~36", "31~41", "42~46",
                                                "47~51","52~56","57~61","62~66","67~71","72~76", ">=77"))) %>%
  dplyr::mutate(Sex = as.character(Gender)) %>%
  dplyr::filter(Sex == "Female" | Sex == "Male") %>%
  dplyr::count(ageBins_pyr, Sex) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100) %>%
  tidyr::complete(ageBins_pyr, Sex, fill=list(Proportion=0)) %>%
  dplyr::mutate(Site = "Ruggeri_etal_2022",
                Sex = ifelse(Sex == "Female", "female_R", "male_R"))

df_census7_age <- df_census7_adults %>%
  dplyr::select(Age, pop_fmale, pop_male) %>%
  dplyr::mutate_if(is.character, as.numeric) %>%
  dplyr::rename(Female = pop_fmale, Male=pop_male) %>%
  tidyr::pivot_longer(cols = c(Male, Female),
                      names_to = "Sex",
                      values_to = "N") %>%
  dplyr::mutate(ageBins = cut(Age,
                              breaks=c(17, 22, 27, 32, 37, 42, 47,
                                            52, 57,62,67,72, 77, Inf), 
                            labels=c("17~21", "22~26", "27~31", "32~36", "31~41", "42~46",
                                     "47~51","52~56","57~61","62~66","67~71","72~76", ">=77")),
                ageBins = factor(ageBins, 
                                 levels = c("17~21", "22~26", "27~31", "32~36", "31~41", "42~46",
                                            "47~51","52~56","57~61","62~66","67~71","72~76", ">=77"))) %>%
  dplyr::group_by(Sex, ageBins) %>%
  dplyr::summarise(N_sum = sum(N)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Proportion = round(N_sum / sum(N_sum), 4) * 100) %>%
  tidyr::complete(ageBins, Sex, fill=list(Proportion=0)) # %>%
  # dplyr::mutate(Site = "Census7_CN",
  #               Sex = ifelse(Sex == "Female", "female_C", "male_C")) %>%
### Plotting
fig1b <- ggplot(data= df_census7_age, aes(x=ageBins, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = dat_age_Ruggeri2022, aes(x=ageBins_pyr,
                                      y = ifelse(Sex == "male_R", -Proportion, Proportion),
                                      group=Sex,color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  # scale_y_continuous(limits = c(-15,15), sec.axis = sec_axis(~.*1, name = "Proportion (Ruggeri2022)")) +
  coord_flip() +
  labs(y="Proportion", x = "Age bins", color=NULL)+
  annotate("text",label= "italic(Male)", x=12,y=-3, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=12,y=4, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue"))+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

```


### Education

The coding of education in Census data and in Ruggeri et al. (2022) is differnt:

In the census data, education was: "no school", "pre school", "primary school", "middle school", "high school", "Technical college", "Bachelor", "Master", "PhD".

In Ruggeri et al. (2022), the edu data is: Primary ed., Secondary ed.,  Technical ed., Bachelor, MBA, Graduate,  PhD.

To make it comparable, we re-code both and used the following schema:
"noschool", "primary", "secondary"(include both middle and high school), "Technical college", "Bachelor", "master" (include graduate and MBA), and "PhD".


```{r}
df_census7_adults_edu <- df_census7_edu %>%
  dplyr::filter(Age >= 18) %>%
  dplyr::select(-ends_with("_all")) %>%
  dplyr::select(-starts_with("pop_")) %>%
  dplyr::mutate_if(is.character, as.numeric)

df_census7_adults_edu_sum <-  colSums(df_census7_adults_edu[-1]) %>%
  data.frame()

df_census7_adults_edu_sum$Edu <- rownames(df_census7_adults_edu_sum)

df_census7_adults_edu_sum <- df_census7_adults_edu_sum %>%
  dplyr::rename("N" = ".") %>%
  tidyr::separate(Edu, c("Edu", "Sex"))

df_census7_adults_edu_sum $Source <- "Census7"

# recode the edu:
df_census7_adults_edu_sum <- df_census7_adults_edu_sum %>%
  dplyr::mutate(Edu = ifelse(Edu == "preSchool", "noSchool", 
                             ifelse(Edu == "middle" | Edu == "high", "Secondary", Edu))) %>%
  dplyr::group_by(Sex, Edu) %>%
  dplyr::summarise(N_new = sum(N)) %>%
  dplyr::ungroup()
  
df_census7_adults_edu_sum$Edu<- dplyr::recode(df_census7_adults_edu_sum$Edu, 
                                              noSchool = "NoSchool",
                  elementary = "Primary",
                  Secondary = "Secondary" ,
                  technical = "Technical" ,
                  university = "Bachelor",
                  master ="Master",
                  PhD = "PhD"
                  ) %>%
  factor(., levels = c("NoSchool", "Primary", "Secondary",
                                        "Technical", "Bachelor", "Master", "PhD"))

df_census7_adults_edu_sum_prop <- df_census7_adults_edu_sum %>%
  dplyr::mutate(Sex = ifelse(Sex == "fmale", "Female", "Male")) %>%
  dplyr::arrange(Sex, Edu) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Proportion = round(N_new / sum(N_new), 4) * 100) 
  

dat_cn_edu <- dat_cn %>%
  dplyr::group_by(Gender, EducationCompleted) %>%
  dplyr::summarise(N_edu = n())

dat_cn_edu$Edu <- dplyr::recode(dat_cn_edu$EducationCompleted,
                                Graduate = "Master",
                                MBA = "Master",
                                `Primary ed.` = "Primary",
                                `Secondary ed.` = "Secondary",
                                `Technical ed.` = "Technical",
                                `No formal ed.` = "NoSchool",
                                ) %>%
  factor(., levels = c("NoSchool", "Primary", "Secondary",
                                        "Technical", "Bachelor", "Master", "PhD"))
  
dat_cn_edu_prop <- dat_cn_edu %>%
  # dplyr::select(-EducationCompleted) %>%
  dplyr::filter(Gender == "Male" | Gender == "Female") %>%
  dplyr::mutate(Gender = factor(Gender, levels = c("Female", "Male"))) %>%
  dplyr::rename(Sex = Gender) %>%
  dplyr::arrange(Sex, Edu) %>%
  dplyr::group_by(Sex, Edu) %>%
  dplyr::summarise(N_new = sum(N_edu)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Proportion = round(N_new / sum(N_new), 4) * 100)

fig1c <- ggplot(data= df_census7_adults_edu_sum_prop, 
                aes(x=Edu, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = dat_cn_edu_prop, 
            aes(x=Edu,
                y = ifelse(Sex == "Male", -Proportion, Proportion),
                group=Sex, color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  # scale_y_continuous(limits = c(-15,15), sec.axis = sec_axis(~.*1, name = "Proportion (Ruggeri2022)")) +
  coord_flip() +
  labs(y="Proportion", x = "Edu", color=NULL) + 
  annotate("text",label= "italic(Male)", x=7,y=-10, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=7,y=10, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue")) +
  theme_classic() +
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

fig1 <- fig1a + fig1b + fig1c + plot_annotation(tag_levels = 'A')
ggsave("fig1.pdf", fig1, device = "pdf", width=20, height = 9)

fig1
```


### Geographical distribution

